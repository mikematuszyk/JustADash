<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Creator â€“Â v2</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <!-- Toolbar ------------------------------------------------------ -->
        <div class="toolbar">
            <!-- Canvas Presets ------------------------------------------- -->
            <div class="section">
                <h3>Canvas Presets</h3>
                <div class="control-group">
                    <label>Quick Presets</label>
                    <select id="canvasPresets" onchange="applyPreset()">
                        <option value="">Choose a preset...</option>
                        <option value="custom">Custom</option>
                        <option value="a4-portrait">A4 Portrait (595Ã—842)</option>
                        <option value="a4-landscape">A4 Landscape (842Ã—595)</option>
                        <option value="letter-portrait">US Letter Portrait (612Ã—792)</option>
                        <option value="letter-landscape">US Letter Landscape (792Ã—612)</option>
                        <option value="poster">Poster (600Ã—800)</option>
                        <option value="business-card">Business Card (252Ã—144)</option>
                        <option value="presentation">Presentation 16:9 (800Ã—450)</option>
                        <option value="social-post">Social Media Post (400Ã—400)</option>
                        <option value="banner">Web Banner (728Ã—90)</option>
                    </select>
                </div>
            </div>
            <!-- Canvas Controls ------------------------------------------ -->
            <div class="section">
                <h3>Canvas Controls</h3>
                <div class="control-group">
                    <label>Canvas Width</label>
                    <input type="number" id="canvasWidth" value="800" min="300" max="2000">
                </div>
                <div class="control-group">
                    <label>Canvas Height</label>
                    <input type="number" id="canvasHeight" value="600" min="200" max="2000">
                </div>
                <button class="btn" onclick="updateCanvasSize()">Update Canvas</button>
            </div>
            <!-- Save / Load --------------------------------------------- -->
            <div class="section">
                <h3>Save & Load</h3>
                <div class="control-group">
                    <button class="btn" onclick="saveProject()"
                        style="background:linear-gradient(135deg,#17a2b8 0%, #138496 100%);">ðŸ’¾ Save Project</button>
                </div>
                <div class="control-group">
                    <label>Load Project</label>
                    <input type="file" id="loadFile" accept=".json" onchange="loadProject()" style="padding:5px;">
                </div>
            </div>
            <!-- Export ---------------------------------------------------- -->
            <div class="section">
                <h3>Export</h3>
                <div class="control-group">
                    <label>Export Format</label>
                    <select id="exportFormat">
                        <option value="html">HTML Document</option>
                        <option value="pdf">PDF Document</option>
                        <option value="png">PNG Image</option>
                    </select>
                </div>
                <button class="btn" onclick="exportCanvas()"
                    style="background:linear-gradient(135deg,#28a745 0%, #20c997 100%);">ðŸ“„ Export Canvas</button>
                <div id="exportStatus" style="margin-top:10px; font-size:12px; color:#666;"></div>
            </div>
            <!-- Add Widgets ---------------------------------------------- -->
            <div class="section">
                <h3>Add Widgets</h3>
                <div class="control-group">
                    <label>Widget Type</label>
                    <select id="widgetType"></select>
                </div>
                <button class="btn" onclick="addWidget()">Add Widget</button>
            </div>
            <!-- Widget List --------------------------------------------- -->
            <div class="section">
                <h3>Widget List</h3>
                <div class="widget-list" id="widgetList">
                    <div class="widget-item">No widgets yet</div>
                </div>
            </div>
        </div>

        <!-- Canvas ------------------------------------------------------- -->
        <div class="canvas-container">
            <div class="canvas" id="canvas"></div>
        </div>

        <!-- Side Panel --------------------------------------------------- -->
        <div class="sidepanel" id="sidepanel"></div>
    </div>

    <!-- ================================================================ -->
    <!--  JavaScript (v2 â€“ geometry & props split)                      -->
    <!-- ================================================================ -->
    <script>
        /*----------------------------------------------------------------
         *  0. Helpers                                                   
         *---------------------------------------------------------------*/
        function pluckParamValues(widget) {
            const obj = {};
            Object.entries(widget.parameters).forEach(([k, p]) => (obj[k] = p.value));
            return obj;
        }

        /*----------------------------------------------------------------
         *  1. Widget Registry                                            
         *---------------------------------------------------------------*/
        const WidgetRegistry = {
            widgets: new Map(),

            register(name, widgetClass, config = {}) {
                this.widgets.set(name, {
                    class: widgetClass,
                    label: config.label || name.charAt(0).toUpperCase() + name.slice(1),
                    description: config.description || '',
                    defaultSize: config.defaultSize || { width: 100, height: 80 }
                });
            },

            create(type, x, y, width, height) {
                const widgetInfo = this.widgets.get(type);
                if (!widgetInfo) throw new Error(`Widget type '${type}' not found`);

                const size = widgetInfo.defaultSize;
                return new widgetInfo.class(
                    x,
                    y,
                    width || size.width,
                    height || size.height
                );
            },

            getAll() {
                return Array.from(this.widgets.entries()).map(([key, value]) => ({ type: key, ...value }));
            }
        };

        /*----------------------------------------------------------------
         *  2. BaseWidget (generic rectangle) â€“Â updated v2                
         *---------------------------------------------------------------*/
        let widgets = [],
            selectedWidget = null,
            nextZIndex = 1000;
        const canvas = document.getElementById('canvas');

        class BaseWidget {
            constructor(x = 50, y = 50, width = 100, height = 80, type = 'basic') {
                this.id = `widget_${Date.now()}_${Math.random().toString(36).slice(2)}`;
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.type = type;
                this.zIndex = nextZIndex++;

                this.selected = this.dragging = this.resizing = false;
                this.dragOffset = { x: 0, y: 0 };
                this.resizeData = null;

                this.defineParameters();
                this.createDOMElement();
                this.attachEventListeners();
            }

            /* ----- Parameter schema ---------------------------------- */
            defineParameters() {
                this.parameters = {
                    x: { type: 'int', label: 'X Position', min: 0, value: this.x },
                    y: { type: 'int', label: 'Y Position', min: 0, value: this.y },
                    width: { type: 'int', label: 'Width', min: 20, max: 2000, value: this.width },
                    height: { type: 'int', label: 'Height', min: 20, max: 2000, value: this.height },
                    backgroundColor: { type: 'color', label: 'Background', value: '#667eea' }
                };
            }

            /* ----- DOM / Style --------------------------------------- */
            createDOMElement() {
                this.element = document.createElement('div');
                this.element.className = 'widget';
                this.element.id = this.id;
                this.updateStyles();
                this.updateContent();
                this.element.style.zIndex = this.zIndex;
            }

            updateStyles() {
                Object.assign(this.element.style, {
                    left: `${this.x}px`,
                    top: `${this.y}px`,
                    width: `${this.width}px`,
                    height: `${this.height}px`
                });
            }

            updateContent() {
                this.element.textContent = this.type.charAt(0).toUpperCase() + this.type.slice(1);
            }

            /* ----- Event listeners (drag / resize / select) ----------- */
            attachEventListeners() {
                // âš ï¸  listeners bound once here & removed via named fns.
                this.element.addEventListener('mousemove', this._handleCursor.bind(this));
                this.element.addEventListener('mouseleave', this._resetCursor.bind(this));
                this.element.addEventListener('mousedown', this._handleMouseDown.bind(this));
                this.element.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.select();
                });
            }

            _handleCursor(e) {
                if (this.dragging || this.resizing) return;
                const rect = this.element.getBoundingClientRect();
                const x = e.clientX - rect.left,
                    y = e.clientY - rect.top,
                    t = 8; // edgeâ€‘threshold
                const onEdge = x <= t || y <= t || x >= rect.width - t || y >= rect.height - t;
                if (!onEdge) {
                    this.element.style.cursor = 'move';
                    return;
                }
                let dir = '';
                if (y <= t) dir += 'n'; else if (y >= rect.height - t) dir += 's';
                if (x <= t) dir += 'w'; else if (x >= rect.width - t) dir += 'e';
                this.element.style.cursor = `${dir}-resize`;
            }
            _resetCursor() {
                if (!this.dragging && !this.resizing) this.element.style.cursor = 'move';
            }

            _handleMouseDown(e) {
                e.stopPropagation();
                this.bringToFront();
                const rect = this.element.getBoundingClientRect();
                const x = e.clientX - rect.left,
                    y = e.clientY - rect.top,
                    t = 8;
                const onEdge = x <= t || y <= t || x >= rect.width - t || y >= rect.height - t;

                onEdge
                    ? this.startEdgeResize(e, this.element.style.cursor.replace('-resize', ''))
                    : this.startDrag(e);
            }

            /* ----- Zâ€‘ordering ---------------------------------------- */
            bringToFront() {
                this.zIndex = nextZIndex++;
                this.element.style.zIndex = this.zIndex;
            }
            sendToBack() {
                this.zIndex = Math.min(...widgets.map((w) => w.zIndex)) - 1;
                this.element.style.zIndex = this.zIndex;
            }
            moveUp() {
                const higher = widgets.filter((w) => w.zIndex > this.zIndex).map((w) => w.zIndex);
                if (higher.length) {
                    this.zIndex = Math.min(...higher) + 1;
                    this.element.style.zIndex = this.zIndex;
                }
            }
            moveDown() {
                const lower = widgets.filter((w) => w.zIndex < this.zIndex).map((w) => w.zIndex);
                if (lower.length) {
                    this.zIndex = Math.max(...lower) - 1;
                    this.element.style.zIndex = this.zIndex;
                }
            }

            /* ----- Drag ------------------------------------------------ */
            startDrag(e) {
                this.dragging = true;
                this.element.classList.add('dragging');
                const rect = canvas.getBoundingClientRect();
                this.dragOffset = {
                    x: e.clientX - rect.left - this.x,
                    y: e.clientY - rect.top - this.y
                };
                this.element.style.cursor = 'grabbing';
                document.addEventListener('mousemove', (this._drag = this._doDrag.bind(this)));
                document.addEventListener('mouseup', (this._drop = this.stopDrag.bind(this)));
            }
            _doDrag(e) {
                if (!this.dragging) return;
                const rect = canvas.getBoundingClientRect();
                const newX = e.clientX - rect.left - this.dragOffset.x;
                const newY = e.clientY - rect.top - this.dragOffset.y;
                this.x = Math.max(0, Math.min(newX, canvas.offsetWidth - this.width));
                this.y = Math.max(0, Math.min(newY, canvas.offsetHeight - this.height));
                this.parameters.x.value = this.x;
                this.parameters.y.value = this.y;
                this.updateStyles();
                if (this.selected) this.updateSidebarValues();
            }
            stopDrag() {
                this.dragging = false;
                this.element.classList.remove('dragging');
                this.element.style.cursor = 'move';
                document.removeEventListener('mousemove', this._drag);
                document.removeEventListener('mouseup', this._drop);
            }

            /* ----- Resize --------------------------------------------- */
            startEdgeResize(e, dir) {
                this.resizing = true;
                this.element.classList.add('resizing');
                this.element.style.cursor = `${dir}-resize`;
                this.resizeData = {
                    dir,
                    startX: e.clientX,
                    startY: e.clientY,
                    startW: this.width,
                    startH: this.height,
                    startL: this.x,
                    startT: this.y
                };
                document.addEventListener('mousemove', (this._resize = this._doResize.bind(this)));
                document.addEventListener('mouseup', (this._stopResize = this.stopResize.bind(this)));
            }
            _doResize(e) {
                if (!this.resizing) return;
                const { dir, startX, startY, startW, startH, startL, startT } = this.resizeData;
                let dX = e.clientX - startX,
                    dY = e.clientY - startY,
                    w = startW,
                    h = startH,
                    x = startL,
                    y = startT;
                if (dir.includes('e')) w = Math.max(20, startW + dX);
                else if (dir.includes('w')) {
                    w = Math.max(20, startW - dX);
                    x = startL + (startW - w);
                }
                if (dir.includes('s')) h = Math.max(20, startH + dY);
                else if (dir.includes('n')) {
                    h = Math.max(20, startH - dY);
                    y = startT + (startH - h);
                }
                x = Math.max(0, Math.min(x, canvas.offsetWidth - w));
                y = Math.max(0, Math.min(y, canvas.offsetHeight - h));
                Object.assign(this, { x, y, width: w, height: h });
                Object.assign(this.parameters, {
                    x: { ...this.parameters.x, value: x },
                    y: { ...this.parameters.y, value: y },
                    width: { ...this.parameters.width, value: w },
                    height: { ...this.parameters.height, value: h }
                });
                this.updateStyles();
                this.updateContent();
                if (this.selected) this.updateSidebarValues();
            }
            stopResize() {
                this.resizing = false;
                this.element.classList.remove('resizing');
                this.element.style.cursor = 'move';
                document.removeEventListener('mousemove', this._resize);
                document.removeEventListener('mouseup', this._stopResize);
            }

            /* ----- Properties & parameters ---------------------------- */
            updateSidebarValues() {
                ['x', 'y', 'width', 'height'].forEach((id) => {
                    const el = document.getElementById(`param_${id}`);
                    if (el) el.value = this[id];
                });
            }
            updateProperty(prop, val) {
                const p = this.parameters[prop];
                if (p) {
                    if (['int'].includes(p.type)) val = parseInt(val) || 0;
                    if (['float', 'number'].includes(p.type)) val = parseFloat(val) || 0;
                    if (p.type === 'checkbox') val = Boolean(val);
                    p.value = val;
                }
                this[prop] = val;
                this.applyPropertyChange(prop, val);
            }
            applyPropertyChange(prop, val) {
                if (['x', 'y', 'width', 'height'].includes(prop)) this.updateStyles();
                if (prop === 'backgroundColor') {
                    this.element.style.background = val;
                    this.element.style.backgroundImage = 'none';
                }
            }

            /* ----- Selection ------------------------------------------ */
            select() {
                widgets.forEach((w) => {
                    w.selected = false;
                    w.element.classList.remove('selected');
                });
                this.selected = true;
                this.element.classList.add('selected');
                selectedWidget = this;
                this.showSidePanel();
                updateWidgetList();
            }

            /* ----- Sideâ€‘panel ----------------------------------------- */
            showSidePanel() {
                const side = document.getElementById('sidepanel');
                side.innerHTML = `
                    <div class="section">
                        <h3>${this.type.charAt(0).toUpperCase() + this.type.slice(1)} Widget</h3>
                        ${this.generateParameterControls()}
                        ${this.generateLayerControls()}
                        <button class="btn" onclick="deleteSelectedWidget()" style="background:linear-gradient(135deg,#ff6b6b 0%,#ee5a24 100%);">Delete Widget</button>
                    </div>`;
            }
            generateLayerControls() {
                return `
                    <div class="control-group">
                        <label>Layer Controls</label>
                        <div class="layer-controls">
                            <button class="btn layer-btn" onclick="selectedWidget.bringToFront(); updateWidgetList();">Front</button>
                            <button class="btn layer-btn" onclick="selectedWidget.moveUp();      updateWidgetList();">Up</button>
                            <button class="btn layer-btn" onclick="selectedWidget.moveDown();    updateWidgetList();">Down</button>
                            <button class="btn layer-btn" onclick="selectedWidget.sendToBack();  updateWidgetList();">Back</button>
                        </div>
                        <div class="layer-info">Z-Index: ${this.zIndex}</div>
                    </div>`;
            }
            generateParameterControls() {
                return Object.entries(this.parameters)
                    .map(([key, p]) => {
                        const id = `param_${key}`;
                        const common = `id="${id}" onchange="updateWidgetParameter('${key}', this.${p.type === 'checkbox' ? 'checked' : 'value'})"`;
                        let input = '';
                        switch (p.type) {
                            case 'int':
                            case 'number':
                                input = `<input type="number" ${common} value="${p.value}" ${p.min ? `min="${p.min}"` : ''} ${p.max ? `max="${p.max}"` : ''} ${p.step ? `step="${p.step}"` : ''}>`;
                                break;
                            case 'float':
                                input = `<input type="number" ${common} step="0.1" value="${p.value}">`;
                                break;
                            case 'color':
                                input = `<input type="color" class="color-input" ${common} value="${p.value}">`;
                                break;
                            case 'textarea':
                                input = `<textarea ${common} rows="${p.rows || 3}">${p.value}</textarea>`;
                                break;
                            case 'select':
                                input = `<select ${common}>${p.options
                                    .map((o) => `<option value="${o.value}" ${o.value === p.value ? 'selected' : ''}>${o.label}</option>`)
                                    .join('')}</select>`;
                                break;
                            case 'checkbox':
                                input = `<input type="checkbox" style="width:auto; margin-right:10px;" ${common} ${p.value ? 'checked' : ''}>`;
                                break;
                            case 'range':
                                input = `<input type="range" ${common} value="${p.value}" min="${p.min || 0}" max="${p.max || 100}" step="${p.step || 1}" oninput="this.nextElementSibling.textContent=this.value"><span>${p.value}</span>`;
                                break;
                            default:
                                input = `<input type="text" ${common} value="${p.value}">`;
                        }
                        return `<div class="control-group"><label>${p.label}</label>${input}</div>`;
                    })
                    .join('');
            }

            /* ----- Serialization â€“ v2 --------------------------------- */
            serialize() {
                // geometry only
                return {
                    id: this.id,
                    type: this.type,
                    x: this.x,
                    y: this.y,
                    width: this.width,
                    height: this.height,
                    zIndex: this.zIndex
                };
            }

            static deserialize(state, props = {}) {
                const Cls = WidgetRegistry.widgets.get(state.type)?.class || BaseWidget;
                const w = new Cls(state.x, state.y, state.width, state.height);

                w.id = state.id;
                w.zIndex = state.zIndex;
                w.element.style.zIndex = w.zIndex;

                // Apply stored properties
                Object.entries(props).forEach(([k, v]) => w.updateProperty(k, v));

                return w;
            }

            /* ----- Destroy -------------------------------------------- */
            destroy() {
                this.element.remove();
            }
        }

        /*----------------------------------------------------------------
         *  3. TextWidget (extends Base) â€“ no custom deserialize needed  
         *---------------------------------------------------------------*/
        class TextWidget extends BaseWidget {
            constructor(x, y, w, h) {
                super(x, y, w, h, 'text');
                this.text = 'Sample Text';
                this.fontSize = 16;
                this.textColor = '#333';
                this.backgroundColor = '#f0f0f0';
                this.fontWeight = 'normal';
                this.textAlign = 'center';
                this.element.style.padding = '8px';
                this.element.style.boxSizing = 'border-box';
                this.element.style.whiteSpace = 'normal';
                this.element.style.lineHeight = '1.2';
                this.updateContent();
            }
            defineParameters() {
                super.defineParameters();
                this.parameters.backgroundColor.value = '#f0f0f0';
                Object.assign(this.parameters, {
                    text: {
                        type: 'textarea',
                        label: 'Text Content',
                        value: this.text,
                        rows: 3,
                        maxlength: 500
                    },
                    fontSize: {
                        type: 'range',
                        label: 'Font Size',
                        value: this.fontSize,
                        min: 8,
                        max: 72,
                        step: 1
                    },
                    textColor: { type: 'color', label: 'Text Color', value: this.textColor },
                    fontWeight: {
                        type: 'select',
                        label: 'Font Weight',
                        value: this.fontWeight,
                        options: [
                            { value: 'normal', label: 'Normal' },
                            { value: 'bold', label: 'Bold' },
                            { value: '300', label: 'Light' },
                            { value: '600', label: 'Semiâ€‘Bold' }
                        ]
                    },
                    textAlign: {
                        type: 'select',
                        label: 'Text Align',
                        value: this.textAlign,
                        options: [
                            { value: 'left', label: 'Left' },
                            { value: 'center', label: 'Center' },
                            { value: 'right', label: 'Right' }
                        ]
                    }
                });
            }
            updateContent() {
                this.element.textContent = this.text;
                Object.assign(this.element.style, {
                    fontSize: `${this.fontSize}px`,
                    fontWeight: this.fontWeight,
                    textAlign: this.textAlign,
                    color: this.textColor,
                    background: this.backgroundColor
                });
            }
            applyPropertyChange(prop, val) {
                super.applyPropertyChange(prop, val);
                if (
                    [
                        'text',
                        'fontSize',
                        'fontWeight',
                        'textAlign',
                        'textColor',
                        'backgroundColor'
                    ].includes(prop)
                )
                    this.updateContent();
            }
            render() {
                const div = document.createElement('div');
                Object.assign(div.style, {
                    position: 'absolute',
                    left: `${this.x}px`,
                    top: `${this.y}px`,
                    width: `${this.width}px`,
                    height: `${this.height}px`,
                    background: this.backgroundColor,
                    color: this.textColor,
                    fontSize: `${this.fontSize}px`,
                    fontWeight: this.fontWeight,
                    textAlign: this.textAlign,
                    fontFamily: 'Arial, sans-serif',
                    padding: '8px',
                    boxSizing: 'border-box',
                    whiteSpace: 'normal',
                    wordBreak: 'break-word',
                    lineHeight: '1.2',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent:
                        this.textAlign === 'left'
                            ? 'flex-start'
                            : this.textAlign === 'right'
                                ? 'flex-end'
                                : 'center',
                    overflow: 'hidden'
                });
                div.textContent = this.text;
                return div;
            }
        }

        /*----------------------------------------------------------------
         *  4. ImageWidget â€“ no custom deserialize needed                
         *---------------------------------------------------------------*/
        class ImageWidget extends BaseWidget {
            constructor(x, y, w, h) {
                super(x, y, w, h, 'image');
                this.imageSrc = '';
                this.borderRadius = 8;
                this.opacity = 1;
                this.objectFit = 'cover';
                this.element.style.background = '#84fab0';
                this.element.innerHTML = '<div style="text-align:center;">ðŸ“·<br>Image</div>';
            }
            defineParameters() {
                super.defineParameters();
                this.parameters.backgroundColor.value = '#84fab0';
                Object.assign(this.parameters, {
                    imageSrc: { type: 'text', label: 'Image URL', value: this.imageSrc },
                    borderRadius: {
                        type: 'range',
                        label: 'Border Radius',
                        value: this.borderRadius,
                        min: 0,
                        max: 50,
                        step: 1
                    },
                    opacity: {
                        type: 'range',
                        label: 'Opacity',
                        value: this.opacity,
                        min: 0.1,
                        max: 1,
                        step: 0.1
                    },
                    objectFit: {
                        type: 'select',
                        label: 'Image Fit',
                        value: this.objectFit,
                        options: [
                            { value: 'cover', label: 'Cover' },
                            { value: 'contain', label: 'Contain' },
                            { value: 'fill', label: 'Fill' },
                            { value: 'scale-down', label: 'Scale Down' }
                        ]
                    }
                });
            }
            applyPropertyChange(prop, val) {
                super.applyPropertyChange(prop, val);
                if (prop === 'imageSrc') {
                    if (val) {
                        this.element.style.backgroundImage = `url(${val})`;
                        this.element.style.backgroundSize = this.objectFit;
                        this.element.style.backgroundPosition = 'center';
                        this.element.innerHTML = '';
                    } else {
                        this.element.style.backgroundImage = '';
                        this.element.innerHTML = '<div style="text-align:center;">ðŸ“·<br>Image</div>';
                    }
                }
                if (prop === 'borderRadius') this.element.style.borderRadius = `${val}px`;
                if (prop === 'opacity') this.element.style.opacity = val;
                if (prop === 'objectFit') this.element.style.backgroundSize = val;
            }
            render() {
                const div = document.createElement('div');
                Object.assign(div.style, {
                    position: 'absolute',
                    left: `${this.x}px`,
                    top: `${this.y}px`,
                    width: `${this.width}px`,
                    height: `${this.height}px`,
                    borderRadius: `${this.borderRadius}px`,
                    opacity: this.opacity,
                    overflow: 'hidden'
                });
                if (this.imageSrc) {
                    Object.assign(div.style, {
                        backgroundImage: `url(${this.imageSrc})`,
                        backgroundSize: this.objectFit,
                        backgroundPosition: 'center',
                        backgroundRepeat: 'no-repeat'
                    });
                } else {
                    Object.assign(div.style, {
                        background: this.backgroundColor,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontFamily: 'Arial, sans-serif',
                        fontSize: '14px',
                        color: '#666'
                    });
                    div.innerHTML = 'ðŸ“·<br>Image';
                }
                return div;
            }
        }

        /*----------------------------------------------------------------
         *  5. Registry setup                                            
         *---------------------------------------------------------------*/
        WidgetRegistry.register('basic', BaseWidget, {
            label: 'Basic Rectangle',
            description: 'Simple colored rectangle'
        });
        WidgetRegistry.register('text', TextWidget, {
            label: 'Text Widget',
            description: 'Text container'
        });
        WidgetRegistry.register('image', ImageWidget, {
            label: 'Image Widget',
            description: 'Image placeholder'
        });

        /*----------------------------------------------------------------
         *  6. Canvas presets + helpers                                  
         *---------------------------------------------------------------*/
        const CANVAS_PRESETS = {
            'a4-portrait': { width: 595, height: 842 },
            'a4-landscape': { width: 842, height: 595 },
            'letter-portrait': { width: 612, height: 792 },
            'letter-landscape': { width: 792, height: 612 },
            poster: { width: 600, height: 800 },
            'business-card': { width: 252, height: 144 },
            presentation: { width: 800, height: 450 },
            'social-post': { width: 400, height: 400 },
            banner: { width: 728, height: 90 }
        };

        function initCanvas() {
            updateCanvasSize();
            populateWidgetSelector();
            canvas.addEventListener('click', (e) => {
                if (e.target === canvas) deselectAllWidgets();
            });
            showCanvasProperties();
        }

        function applyPreset() {
            const p = CANVAS_PRESETS[document.getElementById('canvasPresets').value];
            if (p) {
                document.getElementById('canvasWidth').value = p.width;
                document.getElementById('canvasHeight').value = p.height;
                updateCanvasSize();
            }
        }

        function updateCanvasSize() {
            const w = +document.getElementById('canvasWidth').value,
                h = +document.getElementById('canvasHeight').value;
            canvas.style.width = `${w}px`;
            canvas.style.height = `${h}px`;
            document.querySelectorAll('#currentSize').forEach((el) => (el.textContent = `${w} Ã— ${h}`));
        }
        function updateCanvasColor() {
            const c = document.getElementById('canvasColor').value;
            canvas.style.backgroundColor = c;
        }

        /*----------------------------------------------------------------
         *  7. Widget operations                                         
         *---------------------------------------------------------------*/
        function populateWidgetSelector() {
            const sel = document.getElementById('widgetType');
            sel.innerHTML = '';
            WidgetRegistry.getAll().forEach((w) => {
                const o = document.createElement('option');
                o.value = w.type;
                o.textContent = w.label;
                o.title = w.description;
                sel.appendChild(o);
            });
        }

        function addWidget() {
            const type = document.getElementById('widgetType').value;
            if (!type) return;
            const x = Math.random() * (canvas.offsetWidth - 150),
                y = Math.random() * (canvas.offsetHeight - 80);
            const w = WidgetRegistry.create(type, x, y);
            if (type === 'basic') w.element.style.background = w.parameters.backgroundColor.value;
            widgets.push(w);
            canvas.appendChild(w.element);
            updateWidgetCount();
            updateWidgetList();
        }

        function updateWidgetParameter(prop, val) {
            if (selectedWidget) selectedWidget.updateProperty(prop, val);
        }
        function deleteSelectedWidget() {
            if (selectedWidget) {
                widgets.splice(widgets.indexOf(selectedWidget), 1);
                selectedWidget.destroy();
                selectedWidget = null;
                showCanvasProperties();
                updateWidgetCount();
                updateWidgetList();
            }
        }
        function deselectAllWidgets() {
            widgets.forEach((w) => {
                w.selected = false;
                w.element.classList.remove('selected');
            });
            selectedWidget = null;
            showCanvasProperties();
            updateWidgetList();
        }
        function selectWidgetFromList(id) {
            const w = widgets.find((w) => w.id === id);
            if (w) w.select();
        }

        function updateWidgetCount() {
            document.querySelectorAll('#widgetCount').forEach((el) => (el.textContent = widgets.length));
        }
        function updateWidgetList() {
            const list = document.getElementById('widgetList');
            if (!widgets.length) {
                list.innerHTML = '<div class="widget-item">No widgets yet</div>';
                return;
            }
            const sorted = [...widgets].sort((a, b) => b.zIndex - a.zIndex);
            list.innerHTML = sorted
                .map(
                    (w) => `<div class="widget-item ${w.selected ? 'selected' : ''}" onclick="selectWidgetFromList('${w.id}')"><span>${w.type.charAt(0).toUpperCase() + w.type.slice(1)} #${widgets.indexOf(w) + 1}</span><small style="opacity:.7;">Layer ${sorted.indexOf(w) + 1}</small></div>`
                )
                .join('');
        }

        /*----------------------------------------------------------------
         *  8. Save / load & export â€“ v2 schema                          
         *---------------------------------------------------------------*/
        function saveProject() {
            // Split geometry and property values
            const widgetStates = widgets.map((w) => w.serialize());
            const widgetProps = {};
            widgets.forEach((w) => {
                widgetProps[w.id] = pluckParamValues(w);
            });

            const data = {
                version: '2.0',
                canvas: {
                    width: canvas.offsetWidth,
                    height: canvas.offsetHeight,
                    backgroundColor: canvas.style.backgroundColor || '#fff'
                },
                widgetStates,
                widgetProps
            };

            downloadFile(
                JSON.stringify(data, null, 2),
                `canvas-${Date.now()}.json`,
                'application/json'
            );
            showExportStatus('Project saved.');
        }

        function loadProject() {
            const f = document.getElementById('loadFile').files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);

                    // Clear current
                    widgets.forEach((w) => w.destroy());
                    widgets = [];
                    selectedWidget = null;

                    // Canvas
                    document.getElementById('canvasWidth').value = data.canvas.width;
                    document.getElementById('canvasHeight').value = data.canvas.height;
                    updateCanvasSize();
                    canvas.style.backgroundColor = data.canvas.backgroundColor;
                    if (document.getElementById('canvasColor'))
                        document.getElementById('canvasColor').value = data.canvas.backgroundColor;

                    // Determine schema version
                    if (data.version === '2.0' || (data.widgetStates && data.widgetProps)) {
                        // v2 path
                        data.widgetStates.forEach((state) => {
                            const props = data.widgetProps[state.id] || {};
                            const w = BaseWidget.deserialize(state, props);
                            widgets.push(w);
                            canvas.appendChild(w.element);
                            if (w.zIndex >= nextZIndex) nextZIndex = w.zIndex + 1;
                        });
                    } else if (data.widgets) {
                        // fallback to v1
                        data.widgets.forEach((d) => {
                            const w = BaseWidget.deserialize(d, d.parameters || {});
                            widgets.push(w);
                            canvas.appendChild(w.element);
                            if (w.zIndex >= nextZIndex) nextZIndex = w.zIndex + 1;
                        });
                    }

                    updateWidgetCount();
                    updateWidgetList();
                    showCanvasProperties();
                    showExportStatus(`Loaded ${widgets.length} widget(s).`);
                } catch (err) {
                    console.error(err);
                    showExportStatus('Error loading file.');
                }
                document.getElementById('loadFile').value = '';
            };
            r.readAsText(f);
        }

        /* Export functions (HTML/PDF/PNG) remain unchanged; omitted here for brevity */

        /*----------------------------------------------------------------
         *  9. Utility helpers                                           
         *---------------------------------------------------------------*/
        function downloadFile(content, name, type = 'text/plain') {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }
        function showExportStatus(msg) {
            const el = document.getElementById('exportStatus');
            el.textContent = msg;
            el.style.color = msg.toLowerCase().includes('error') ? '#dc3545' : '#28a745';
            setTimeout(() => {
                el.textContent = '';
            }, 5000);
        }

        function showCanvasProperties() {
            const side = document.getElementById('sidepanel');
            side.innerHTML = `<div class="section"><h3>Canvas</h3><p id="currentSize">${canvas.offsetWidth} Ã— ${canvas.offsetHeight}</p><p id="widgetCount">${widgets.length}</p></div>`;
        }

        /*----------------------------------------------------------------
         *  10. Boot                                                    
         *---------------------------------------------------------------*/
        initCanvas();
    </script>
</body>

</html>